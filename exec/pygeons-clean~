#!/usr/bin/env python
import argparse
from pygeons.io.convert import dict_from_hdf5,hdf5_from_dict
import pygeons.interface
import logging

def change_extension(f,ext):
  return '.'.join(f.split('.')[:-1] + [ext])    

p = argparse.ArgumentParser(
  description='''Runs the PyGeoNS interactive cleaner which is used 
                 to remove jumps and outliers''')
p.add_argument(
  'input_file',type=str,metavar='STR',
  help='''Input date file. This must be an HDF5 file''')

p.add_argument(
  '-o','--output_file',type=str,metavar='STR',
  help='''Output file name. If this is not provided then it is the 
          same as the input file name but the extension is removed 
          and replaced with "clean.h5"''')

p.add_argument(
  '-v','--verbose',action='count',default=0,
  help='''controls verbosity''')

p.add_argument('--color_cycle',nargs='+',type=str,metavar='STR')
p.add_argument('--resolution',type=str,metavar='STR')               
p.add_argument('--quiver_scale',type=float,metavar='FLOAT')
p.add_argument('--quiver_key_length',type=float,metavar='FLOAT')
p.add_argument('--quiver_key_pos',nargs=2,type=float,metavar='FLOAT')
p.add_argument('--scatter_size',type=float,metavar='FLOAT')
p.add_argument('--image_clim',nargs=2,type=float,metavar='FLOAT')
p.add_argument('--image_cmap',type=str,metavar='STR')
p.add_argument('--image_array_size',type=int,metavar='INT')
p.add_argument('--ts_title',type=str,metavar='STR')
p.add_argument('--map_title',type=str,metavar='STR')
p.add_argument('--map_xlim',nargs=2,type=float,metavar='FLOAT')
p.add_argument('--map_ylim',nargs=2,type=float,metavar='FLOAT')
p.add_argument('--fontsize',type=float,metavar='FLOAT')
p.add_argument(
  '--break_lons',nargs='+',type=float,metavar='FLOAT',
  help='''Longitudes of the spatial discontinuity vertices''')

p.add_argument(
  '--break_lats',nargs='+',type=float,metavar='FLOAT',
  help='''Latitudes of the spatial discontinuity vertices''')

p.add_argument(
  '--break_conn',nargs='+',type=str,metavar='STR',
  help='''Connectivity of the spatial discontinuity vertices. This can 
          be one or multiple strings where each string contains the 
          vertex indices making up each discontinuity separated by a 
          '-'. For example, '0-1-2 3-4' indicates that there are two 
          discontinuties, one contains vertices 0, 1, and 2 and the 
          other contains vertices 3 and 4''')
               
p = vars(p.parse_args())

# set logger
verbose = p.pop('verbose')
if verbose == 0:
  logging.basicConfig(level=logging.WARNING)
elif verbose == 1:
  logging.basicConfig(level=logging.INFO)
else:
  logging.basicConfig(level=logging.DEBUG)

input_file = p.pop('input_file')
output_file = p.pop('output_file')

# throw out any Nones and let the lower level functions determine the defaults
for k in p.keys(): 
  if p[k] is None: 
    p.pop(k)

if output_file is None:
  output_file = change_extension(input_file,'clean.h5')

data_dict = dict_from_hdf5(input_file) 
out_dict = pygeons.interface.clean(data_dict,**p)
hdf5_from_dict(output_file,out_dict)
