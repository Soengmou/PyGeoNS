#!/usr/bin/env python
import argparse
import json
import sys
import pygeons.ioconv
import pygeons.interface
import logging

p = argparse.ArgumentParser()
p.add_argument('input_file',type=str,
               help='''date file. Can either be a PBO csv file, a PBO 
                       pos file, or a HDF5 file. The file type is 
                       inferred from the extension. ".hdf", ".h5", 
                       ".hdf5", ".he5" are interpretted as HDF5, 
                       ".pos" is interpretted as PBO pos, anything 
                       else is assumed to be a PBO csv file.''')
p.add_argument('sample_period',type=int,
               help='''sample period in days''')
p.add_argument('--output_file',type=str,
               help='''if not provided then the input file extension 
                       is removed and replaced with smooth.h5. The 
                       output file type is inferred from the 
                       extension. Currently, can only output to HDF5 
                       files or PBO csv files.''')
p.add_argument('-v','--verbose',action='count',default=0,
               help='''controls verbosity''')
p.add_argument('--start_date',type=str,
               help='''resample start date in YYYY-MM-DD''')
p.add_argument('--stop_date',type=str,
               help='''resample stop date in YYYY-MM-DD''')
p.add_argument('--cut_times',nargs='+',type=float,
               help='''time discontinuities in decimal year''')
p.add_argument('--cut_dates',nargs='+',type=str,
               help='''time discontinuities in YYYY-MM-DD''')
               
p = vars(p.parse_args())

# set logger
if p['verbose'] == 0:
  logging.basicConfig(level=logging.WARNING)
elif p['verbose'] == 1:
  logging.basicConfig(level=logging.INFO)
else:
  logging.basicConfig(level=logging.DEBUG)

input_file = p['input_file']
output_file = p['output_file']
if output_file is None:
  input_file_split = input_file.split('.')
  output_file_split = input_file_split[:-1] + ['downsample.h5']
  output_file = '.'.join(output_file_split)

data_dict = pygeons.ioconv.dict_from_file(input_file)
out_dict = pygeons.interface.downsample(
             data_dict,
             p['sample_period'],
             start_date=p['start_date'],
             stop_date=p['stop_date'],
             cut_times=p['cut_times'],
             cut_dates=p['cut_dates'])
pygeons.ioconv.file_from_dict(output_file,out_dict)                         
